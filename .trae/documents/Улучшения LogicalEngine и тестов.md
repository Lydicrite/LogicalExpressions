## Обзор

* Библиотека реализует полный цикл: токенизация, две стратегии парсинга, построение AST, нормализация/каноникализация, CNF/DNF, минимизация (QM/Espresso), компиляция в делегаты и быструю побитовую оценку.

* Тесты покрывают корректность, свойства булевой алгебры, позиции ошибок, производительность; есть random/property-based подход.

* Ниже — приоритезированный план улучшений: архитектура API, производительность, надёжность, удобство использования, качество тестов и упаковка.

## API и потокобезопасность

* Сделать `LogicalExpression` по-настоящему иммутабельным: методы `Compile` и нормализация не должны менять `_root`; вместо этого компилировать по канонизированному клону. См. `LogicalExpression.cs:1736` — там происходит мутирующая каноникализация.

* Явно документировать процесс-широкие кэши (AST/Delegate) и их потокобезопасность; добавить возможность включать/выключать глобальные кэши на уровне `LEParserOptions` для сценариев с изоляцией.

* Для сценариев многопоточности добавить фабричный тип `LEContext` с собственными реестрами/кэшами и без статик-состояния.

* Вернуть исходную структуру AST в `ToString()` даже после `Compile`; сейчас канонизация перед компиляцией меняет визуальную форму пользователя.

## Парсинг и токенизация

* Упростить распознавание `"<=>"`: текущая логика, завязанная на алиасы импликации, может быть неочевидной. См. `Tokenizer.cs:56–73`. Выделить явное ветвление для `"<=>"` и его Unicode-алиасов.

* Разрешить более широкий алфавит имён переменных (например, `-`, `'`, `.`) через настраиваемый `Func<char,bool>` в опциях; сейчас только `char.IsLetter/IsDigit/_`.

* Конфигурируемые пробелы и сепараторы: поддержать запятые/точки с запятой как необязательные разделители между токенами.

* Улучшить подсказки алиасов: добавить подсветку различий (diff) и вероятности; вынести `LevenshteinDistance` в утилиту с кэшированием.

## Кэширование и метрики

* AST-кэш: добавить LRU с списком использования вместо сортировки словаря при эвикции; текущая эвикция по `LastAccessTicks` через `OrderBy` ограниченно масштабируется. См. `LEParser.cs:71–91`.

* Delegate-кэш: поле `_delegateEvictPercent` не используется в LRU; либо удалить, либо задействовать в периодической эвикции. См. `LogicalExpression.cs:214–218` и конфиг `ConfigureDelegateCache` на `LogicalExpression.cs:336–342`.

* Вынести метрики (hits/misses/evictions, lifetime) в отдельный `Diagnostics`-API с снапшотами, чтобы не требовался reflection в тестах. См. использование reflection в `LogicalExpressions.Tests\LogicalExpressionsTests.cs:856–866`.

## Вычисление и производительность

* `EvaluateBits` для неподдержанных операторов делает дорогостоящий путь с аллокациями массива на каждый бит. См. `LogicalExpression.cs:2169–2180`. Заменить на `stackalloc` и повторное использование буфера, либо явно запретить fallback в проде и включать только при `Debug`.

* Добавить SIMD/Intrinsics для операций над `ulong` пакетами при больших деревьях; опционально включать через флаг.

* Benchmarking: интегрировать `BenchmarkDotNet` для горячих путей (Tokenize/Validate/ConvertToPostfix/BuildAST/EvaluateBits) вместо adhoc-замеров.

## Нормализация и минимизация

* Консенсусные правила: вернуть и сделать безопасными через проверку эквивалентности по окнам битов; сейчас отключены. См. комментарии в `NormalizerVisitor.cs:371–383`.

* Espresso-алгоритм: вынести в отдельный модуль, добавить больше тестов на покрытие граничных случаев (слияние, редукция, удаление избыточных), валидацию эквивалентности результата.

* Добавить режимы минимизации с ограничениями (максимальная длина терма, лимит времени через `CancellationToken`).

## Диагностика ошибок

* В `LEParseException` добавить структурированные поля для списка ожидаемых категорий токенов и для подсказок (вместо форматированных строк), чтобы UI мог визуально рендерить подсказки. См. `LEParseException.cs:220–270`.

* Расширить проверку последовательности токенов точными случаями: подряд унарные, бинарный после унарного без операнда, `)` сразу после унарного и т.п. См. `LEParser.cs:359–425`.

## Эргономика и расширяемость

* Публичные фасады для CNF/DNF как структуры данных: вернуть не только `LENode`, но и «список термов/клауз» с метаданными; упростит интеграцию с SAT/BDD.

* Серилизация/десериализация AST: `ToJson()/FromJson()` для интеграции с внешними системами.

* Расширяемые операторы: поддержка пользовательских функций `FUNC(X,Y,...)` через регистры с арностью и проверкой в `Tokenizer`/`ParserStrategy`.

## Качество кода

* Включить набор анализаторов: `Meziantou.Analyzer`, `Roslynator.Analyzers`, `IDisposableAnalyzers`; запретить недостижимые ветки, избыточные аллокации, потенциальные гонки.

* Уточнить `RepositoryUrl` и `PackageReadmeFile` в `LogicalEngine.csproj:13–17`; сейчас readme может отсутствовать.

* Переименовать неймспейсы к единому виду (`LEngine.*` уже используется корректно); добавить `InternalsVisibleTo` для тестов, чтобы не пользоваться reflection.

## Тесты

* Заменить ручной random на FsCheck-генераторы: `Arbitrary<LENode>`/`Arbitrary<string>` с shrink-правилами, свойствами (коммутативность, ассоциативность, дистрибутивность, де Морган, идемпотентность, round-trip) — сейчас пакет подключён, но используется нерегулярно.

* Добавить негативные property-тесты токенизатора: случайные шумы/Unicode/несанкционированные символы, верифицировать `LEParseException.Suggestions` и позиции.

* Убрать reflection-доступ к приватным методам; заменить на публичные диагностические точки или `InternalsVisibleTo`.

* Сделать стабильные тесты при параллельном исполнении: очищать глобальные кэши в `TestInitialize`/`TestCleanup`, помечать кэш-чувствительные тесты `DoNotParallelize`.

  <br />

